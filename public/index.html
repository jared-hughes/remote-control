<!DOCTYPE html>
<html>
<body class="partial-screen">

<div id="keyboard">
  <button id="toggle-fullscreen" class="only-partial-screen">
    Toggle fullscreen (for&nbsp;mouse)
  </button>
</div>
<div class="only-full-screen">
  Fullscreen now.
</div>

<style>
body {
  background: white
}

#keyboard {
  display: grid;
  grid-gap: 0.5vw;
  grid-template-columns: repeat(28, 1fr);
  /* height = 1/28 of width
   * fn keys smaller
   * last row taller to accomodate arrow keys
   */
  grid-template-rows: 2.5vw repeat(4, 3.57vw) repeat(2, 2.4vw) 0.5vw 5vw 0.5vw auto;
}

#toggle-fullscreen, .key {
  border-radius: 0.6vw;
  background: hsl(230, 50%, 90%);
}

.key.pressed {
  background: blue;
  background: hsl(230, 50%, 70%);
}

button {
  /* destyle */
  padding: 0;
  border: none;
  font: inherit;
  color: inherit;
  background-color: transparent;
  cursor: pointer;
  opacity: 0.8;
  box-sizing: border-box;
}

button:hover {
  opacity: 1;
}

button:focus {
  outline: none;
  opacity: 0.6;
}

#toggle-fullscreen {
  grid-area: 11 / 9 / 12 / 15;
  font-size: 1.2em;
  padding: 0.6em;
  background: hsl(225, 70%, 50%);
  color: white;
}

.partial-screen .only-full-screen {
  display: none !important;
}

.full-screen .only-partial-screen {
  display: none !important;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
<script>
  const mouseNames = ["#MouseLeft", "#MouseMiddle", "#MouseRight"]
  let keyboard = document.getElementById("keyboard")
  // based on my keyboard, may want configuration
  const keyboardLayout = [
    ["Escape", "F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F11", "F12", "Delete"],
    ["Backquote", "Digit1", "Digit2", "Digit3", "Digit4", "Digit5", "Digit6", "Digit7", "Digit8", "Digit9", "Digit0", "Minus", "Equal", "Backspace"],
    ["Tab", "KeyQ", "KeyW", "KeyE", "KeyR", "KeyT", "KeyY", "KeyU", "KeyI", "KeyO", "KeyP", "BracketLeft", "BracketRight", "Backslash"],
    ["CapsLock", "KeyA", "KeyS", "KeyD", "KeyF", "KeyG", "KeyH", "KeyJ", "KeyK", "KeyL", "Semicolon", "Quote", "Enter"],
    ["ShiftLeft", "KeyZ", "KeyX", "KeyC", "KeyV", "KeyB", "KeyN", "KeyM", "Comma", "Period", "Slash", "ShiftRight"],
    ["ControlLeft", "AltLeft", "Space", "AltRight", "ControlRight", "ArrowLeft", "ArrowUp", null, "ArrowDown", "ArrowRight"],
    // empty line for a second row in the previous row
    [],
    // empty line as spacing from the mouse
    [],
    [null, ...mouseNames, null],
  ]
  const keyboardDimensions = [
    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    [3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3],
    [4, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 4],
    [3, 3, 10, 3, 3, 2, 2, -2, 2, 2],
    [],
    [],
    [6, 4, 2, 4, 12],
  ]
  let keys = {}
  for (let y=0; y < keyboardLayout.length; y++) {
    startX = 1;
    for (let i=0; i < keyboardLayout[y].length; i++) {
      endX = startX + keyboardDimensions[y][i];
      if (keyboardLayout[y][i]) {
        element = document.createElement("div");
        element.classList.add("key");
        element.style.gridRowStart = y + 1;
        element.style.gridRowEnd = y + 2 + (y == 5);
        element.style.gridColumnStart = startX;
        element.style.gridColumnEnd = endX;
        keyboard.appendChild(element);
        keys[keyboardLayout[y][i]] = element;
      }
      startX = endX;
    }
  }
  keys["ArrowUp"].style.gridRowEnd = 7;
  keys["ArrowDown"].style.gridRowStart = 7;
  let selfPressed = {};
  for (let key of Object.keys(keys)) {
    selfPressed[key] = false;
  }
  let socket = io();
  function showKeyup(key) {
    console.log("up", key);
    keys[key].classList.remove("pressed");
  }
  function showKeydown(key) {
    console.log("down", key);
    keys[key].classList.add("pressed");
  }
  socket.on('keyup', showKeyup);
  socket.on('keydown', showKeydown);
  function keyup(key) {
    if (key in keys) {
      selfPressed[key] = false;
      showKeyup(key);
      socket.emit("keyup", key);
    }
  }
  function keydown(key) {
    if (key in keys) {
      if (!event.repeat) {
        selfPressed[key] = true;
        showKeydown(key);
        socket.emit("keydown", key);
      }
    }
  }
  function keyupall() {
    for (let key of Object.keys(keys)) {
      if (selfPressed[key]) {
        keyup(key);
      }
    }
  }
  function preventDefault(event) {
    if (event.code == "Tab") {
      // avoid tabbing out, but allow other shortcuts
      event.preventDefault();
    }
  }

  /* Key presses */
  window.addEventListener("keyup", event => {
    preventDefault(event);
    keyup(event.code);
  });
  window.addEventListener("keydown", event => {
    preventDefault(event);
    keydown(event.code);
  });

  /* Mouse clicks */
  window.addEventListener("mousedown", event => {
    keydown(mouseNames[event.button]);
  });
  window.addEventListener("mouseup", event => {
    keyup(mouseNames[event.button]);
  });
  window.addEventListener("contextmenu", event => {
    event.preventDefault();
  })

  /* Scroll wheel movement */
  window.addEventListener("wheel", event => {
    socket.emit("wheel", [event.deltaX, event.deltaY]);
  })
  // for when the user defocuses the browser tab
  window.addEventListener("blur", keyupall);

  /* Full screen handling + Mouse */
  function mouseMoveListener(event) {
    data = [event.movementX, event.movementY];
    console.log("mousemove", data);
    socket.emit("mousemove", data);
  }
  let isFullscreen = false;
  function toggleFullscreenElements() {
    isFullscreen = !isFullscreen;
    if (isFullscreen) {
      document.body.classList.add("full-screen");
      document.body.classList.remove("partial-screen");
      // https://developer.mozilla.org/en-US/docs/Web/API/Element/requestPointerLock
      // need to track events to check success/failure
      document.addEventListener("pointerlockchange", () => {
        // On successful pointer lock
        document.addEventListener("mousemove", mouseMoveListener)
      });
      document.body.requestPointerLock();
    } else {
      document.body.classList.remove("full-screen");
      document.body.classList.add("partial-screen");
      document.exitPointerLock();
      document.removeEventListener("mousemove", mouseMoveListener);
    }
  }
  document.addEventListener("fullscreenchange", toggleFullscreenElements);
  // Calls toggleFullscreenElements through fullscreenchange event
  // If requsetFullscreen, we just won't go fullscreen
  document.getElementById("toggle-fullscreen")
  .addEventListener("click", document.body.requestFullscreen);
</script>

</body>
</html>
